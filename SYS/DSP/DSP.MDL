	.TITLE DSP.MDL
	.MCALL .TTYOUT,.TTINR,.TTYIN,.PRINT

	.INCLUDE /DK:MNU.MDL/

MSGERR::
	MOV	R0,-(SP)
	TST	MSGITM
	BEQ	1$
	MOV	MSGTXT,-(SP)
	MOV	MSGITM,MSGTXT
	CALL	MSGOUT
	MOV	(SP)+,MSGTXT
1$:	.PRINT	#100$
	ITM.NAM MSGTTL,R0
	.PRINT
	.PRINT	#101$
	ITM.NAM MSGTXT,R0
	.PRINT
	.PRINT	#102$
	MOV	(SP)+,R0
	RETURN

100$:	.BYTE 16,200
101$:	.ASCII /> : "/<200>
102$:	.BYTE '",17,0
	.EVEN

MSGTTL::.WORD
MSGTXT::.WORD
MSGITM::.WORD

STRFML: .WORD 5.,MSGFML,MSGFML+6,MSGFML+10,MSGFML+12,MSGFML+14
STROUT::
	MOV	R2,-(SP)
	MOV	#STRFML,R2
	CALL	MSGSCR
	MOV	(SP)+,R2
	RETURN

OUTFML: .WORD 8.,MSGFML,MSGFML+2,MSGFML+4,MSGFML+6,MSGFML+10
	.WORD MSGFML+12,MSGFML+14,MSGFML+16
MSGOUT::
	MOV	R2,-(SP)
	MOV	#OUTFML,R2
	CALL	MSGSCR
	MOV	(SP)+,R2
	RETURN

MSGFML: .WORD DS$RUS,,DS$PRG,,DS$BRK,,DS$ENG,DS$LFCR
MSGSCR:
	MOV	R1,-(SP)
	MOV	R0,-(SP)
	MOV	MSGTXT,R1
	BEQ	5$
	ITM.NAM MSGTTL,MSGFML+2
	ITM.NAM R1,MSGFML+6
	CLR	MSGFML+10
	CLR	MSGFML+12
	TST	@R1		;  ?
	BEQ	1$		;

	MOV	MSGITM,R0
	TST	2(R1)
	BEQ	1$
	CMP	2(R1),#STUB
	BEQ	30$
	TST	R0
	BEQ	1$
30$:
	MOV	#DS$BRK,MSGFML+10
	CALL	@2(R1)		; 

	CMP	@R1,#1		; ?
	BEQ	20$		;
10$:
	CMP	@R1,#2		; ?
	BNE	11$		;
	.BINOCT R0
	.NULCLR R0
	BR	20$
11$:
	CMP	@R1,#3		; ?
	BNE	12$		;
	.BINDEC R0
	.NULCLR R0
12$:
	CMP	@R1,#4		; ?
	BNE	20$		;
	.BINHEX R0
	.NULCLR R0
20$:
	MOV	R0,MSGFML+12
1$:
	MOV	R5,-(SP)
	MOV	R2,R1
	MOV	(R1)+,R5
2$:
	MOV	@(R1)+,R0
	BEQ	3$
	.PRINT
3$:
	SOB	R5,2$
	MOV	(SP)+,R5
4$:	MOV	(SP)+,R0
	MOV	(SP)+,R1
	RETURN
5$:
	MOV	#DS$LFCR,R0	; 
	.PRINT
	BR	4$


KEYINP::
	MOV	R1,-(SP)
	MOV	@#44,-(SP)
	MOV	R0,R1
	BIS	#10000,@#44
	BIC	#100,@#44
	.TTINR
	BCS	1$

	TST	R1
	BEQ	1$
	CMP	R0,R1
	BEQ	1$
	SEC
1$:	MOV	(SP)+,@#44
	MOV	(SP)+,R1
	RETURN

KEYOUT::
	MOV	R5,-(SP)
	MOV	R1,-(SP)
	MOV	R0,-(SP)

	;   
	MOV	@#44,-(SP)
	BIS	#10000,@#44
	BIC	#100,@#44
	.TTYIN
	MOV	(SP)+,@#44
	
	MOV	@SP,R5		;-   
1$:	MOV	R5,R1
	ASL	R1
	ADD	SP,R1
	CMP 	R0,6(R1)
	BEQ	2$
	DEC	R5
	BGT	1$
	CLR	100$
	BR	3$
2$:
	MOV	@SP,R0
	SUB	R5,R0
	INC	R0
	MOV	R0,100$
3$:
	MOV	(SP)+,R0
	MOV	(SP)+,R1
	MOV	(SP)+,R5
5$:	MOV	(SP)+,(SP)
	SOB	R0,5$
	MOV	100$,R0
	RETURN

100$:	.WORD

