	.TITLE TRPZU.MAC

	.ASECT

;	 

;			000000-000576
	.REPT	96.
	.WORD	VEKXX,340
	.ENDR
	.=0
	.WORD	BGN,340
	.WORD	VEK4,340
	.WORD	VEK10,340
	.WORD	VEK14,340
	.WORD	SAVRON,340
	.WORD	VEK24,340
	.WORD	VEK30,340
	.WORD	VEK34,340
	.=100
	.WORD	VEK100,340
	.=170
	.WORD	VEK170,340
	.WORD	VEK174,340
	.=250
	.WORD	VEK250,340
	.=274
	.WORD	VEK274,340
	.=46
	$ENDAD
	.=52
	.WORD	0

	.=400
$MAIL:	.WORD	0
$FATAL:	.WORD	0	;	 
$TESTN:	.WORD	0	;	 
$PASS:	.WORD	0	;	 
$DEVCT:	.WORD	0
$UNIT:	.WORD	0
$MSGAD:	.WORD	0
$MSGLG:	.WORD	0
$ENV:	.BYTE	0
$ENVM:	.BYTE	0
$SWREG:	.WORD	0
$USWR:	.WORD	0
$CPUOP:	.WORD	0
$MTYP1:	.WORD	0
$MADR1:	.WORD	0
$MTYP2:	.WORD	0
$MADR2:	.WORD	0
$MTYP3:	.WORD	0
$MADR3:	.WORD	0
$MTYP4:	.WORD	0
$MADR4:	.WORD	0
$APTHD:	.WORD	0
$MBADR:	.WORD	$MAIL
$TSTM:	.WORD	11
$PASTM:	.WORD	11
$UNITM:	.WORD	0
	.WORD	24
	.=200
BGN:	MOV	#VEK0,0
	BR	1$
	.=210
	CLR	@#$PASS
1$:	JMP	START
	.=500
BUFF:	0

START:
;;;	MOV	#BFR$R,@#$PASS
	MOV	#BUFF,SP
	CLR	$MAIL
	CLR	$FATAL
RESTRT:	MOV	#BUFF,SP
	CLR	$TESTN
	JMP	TST1

TST1:
	INC	@#$TESTN
	CMP	#1,@#$TESTN
	BNE	TST2-12
	MTPS	#340		;  

	MOV	#VOUT,@#100
	CLR	INT100
        CALL	Z300MS		;    100     

	TST	INT100		; ?
	BNE	TST2		;
	MOV	#13,@#$FATAL
	IOT
	BR	.
	MOV	#1,@#$FATAL
	IOT
	BR	.

TST2:
	INC	@#$TESTN
	CMP	#2,@#$TESTN
	BNE	TST3-12

	MOV	#VPPO,@#24
	CLR	INTPRI
        CALL	Z300MS		;    24     

	TST	INTPRI		; ?
	BNE	TST3		;
	MOV	#14,@#$FATAL
	IOT
	BR	.
	MOV	#2,@#$FATAL
	IOT
	BR	.

TST3:
	INC	@#$TESTN
	CMP	#3,@#$TESTN
	BNE	TST4-12
	MTPS	#340		;  

        CALL	TST.KA		;  1     
	MOV	R2,@#$FATAL
	BEQ	TST4
	IOT
	BR	.
	MOV	#3,@#$FATAL
	IOT
	BR	.

TST4:
	INC	@#$TESTN
	CMP	#4,@#$TESTN
	BNE	TST5-12

        CALL	TST.KB		;  2     
	MOV	R2,@#$FATAL
	BEQ	TST5
	IOT
	BR	.
	MOV	#4,@#$FATAL
	IOT
	BR	.

TST5:
	INC	@#$TESTN
	INC	@#$PASS
	JMP	.

; *******************************************************
;                0   (RK0)
; *******************************************************
        RK0     =177660 ;   
                        ;
                        ;  0    1  /  1: , 0: 
                        ;  1    2  /  -
                        ;  2    3  /  -
                        ;  3    4  /  -
                        ;  4    5  /  -
                        ;  5    6  /  -
        B$SBRS  =   100 ;  6    /
                        ;               0: 
                        ;               1: . )
        B$ZINT  =   200 ;  7      
                        ;               0: 
                        ;               1: 
        B$KMAN  =   400 ;  8    /
                        ;               0: 
                        ;               1: 
        B$IMPL  =  1000 ;  9     
                        ;               0: 
                        ;               1: 
        B$TLF   =  2000 ; 10    /
                        ;               0: 
                        ;               1: 
        B$TACP  =  4000 ; 11     
                        ;               0: 
                        ;               1: 
        B$DPRS  = 10000 ; 12     
                        ;               0: 
                        ;               1: 
        B$ISPR  = 20000 ; 13    
                        ;               0: .
                        ;               1: .
        B$SVET  = 40000 ; 14    
                        ;               0: 
                        ;               1: 
                        ; 15     
; *******************************************************
;                2   (RST2)
; *******************************************************
        RST2    =177674 ;   
                        ;
                        ; 0-1    
        B$NALL  =     3 ;               3:  
        B$N1    =     2 ;               2:   1
        B$N2    =     1 ;               1:   2
        B$N3    =     0 ;               0:   3
        B$INT   =     4 ;  2       

; *******************************************************
;                 ( )
; *******************************************************
        R$ACP  = 177676 ;   
                        ;
                        ; 0-6  - 
                        ; 7-15 -  

; *******************************************************
;         () - 
; *******************************************************
        R$PRMM = 177666 ;   32   
        R$PRMS = 177670 ;   32   
                        ;
                        ;   
                        ; 0-7   
                        ;               130:  
                        ; 8-9    
                        ;               3:  
                        ;               2:   1
                        ;               1:   2
                        ;               0:   3
                        ; 10    
                        ;               0: 
                        ;               1: 
                        ; 11    /
                        ;               0: - 
                        ;               1: - 
                        ; 12     
                        ; 13    0,5 
                        ;               0: +0,0 
                        ;               1: +0,5 
                        ;14-17   
                        ;18-21   
                        ;22-25   
                        ;26-28   
                        ;29-30  
                        ;               0:  
                        ;               1:  
                        ;               2: 
                        ;               3:  0
                        ; 31     ()

; *******************************************************
;         () - 
; *******************************************************
        R$PRDM = 177666 ;   32   
        R$PRDS = 177670 ;   32   
                        ;
                        ;   
                        ; 0-7   
                        ;               116:  
                        ; 8-9    
                        ;               3:  
                        ;               2:   1
                        ;               1:   2
                        ;               0:   3
                        ;10-16  
                        ;17-28    
                        ;29-30  
                        ;               0:  
                        ;               1:  
                        ;               2: 
                        ;               3:  0
                        ; 31     ()

; *******************************************************
;                 
; *******************************************************
        R$UCPP  =177664 ;   
                        ;
        B$UPRA  =     1 ;  0     
                        ;               0:   
                        ;               1:   
        B$UPRB  =     2 ;  1     
                        ;               0:   
                        ;               1:   
        B$UAB   =     4 ;  2     
                        ;               0:  
                        ;               1:  
        B$ICPP  =    10 ;  3    . 

;*********************************************************
B$3SEC	=	6667.		;  3 
B$90G 	=	4000		; 90 
B$135G	=	6000		;135 
B$315G	=	176000		;315 
B$40G	=	1616		; 40 
B$180G	=	170000		;180 

; *************************************************************
;		  -
; *************************************************************
; IN	-	
;
; LOCAL	-	
;
; OUT	-	R2
; *************************************************************
;  .
;    0	-	    
;    1	-	  1   
;    4	-	    B
;    6	-	  2   B

TST.KA:
;	BIS	#B$FK,STATUS	; .
	;;;CALL	TSTMIG
	;;;CALL	TSTUPR

	MOV	#1,SUCPP	;  1   
	MOV	SUCPP,R$UCPP
	MOV	#26315,R0	;F = 1666,5 
	CALL	OUT130		;   

	CALL	TIOCPP
	BEQ	3$
	BMI	1$

	MOV	#19.,R2		;: 19 (    )
	BR	2$
1$:	MOV	#18.,R2		;: 18 (   
2$:				;	     1   )
	RETURN
3$:	CLR	R2
	RETURN

TST.KB:
;	BIS	#B$FK,STATUS	; .
	;;;CALL	TSTMIG
	;;;CALL	TSTUPR

	MOV	#6,SUCPP	;  2   
	MOV	SUCPP,R$UCPP
	MOV	#11462,R0	;F = 999 
	CALL	OUT130		;   
	CALL	TIOCPP
	BEQ	3$
	BPL	1$

	MOV	#28.,R2		;: 28 (   
	BR	2$		;	     2   )
1$:	MOV	#29.,R2		;: 29 (    )
2$:				;	     1   )
	RETURN
3$:	CLR	R2
	RETURN


;*******************************
TIOCPP:
	MOV	INTPRI,-(SP)	;   
	MOV	INTUPR,-(SP)	;    ( MDIN.MAC)
	BIC	#B$ZINT,SRK0	; 
	MOV	SRK0,RK0

	MOV	INT100,R1	;  
	CLR	R0		;  
	CLR	R2
	MOV	#123456,BF.HZ	;   
	MOV	#54321,BF.HZ+2
	MOV	#123456,KONKUR
	MOV	#54321,KONKUR+2
1$:	
	CMP	R0,#B$3SEC/6	; 500 
	BGE	6$
	WAIT
	CMP	R1,INT100
	BNE	3$
	INC	R2
	BLT	2$
	CMP	R2,#4		;  
	BLT	4$		;   58,6   4 =234,4 
2$:	MOV	#20.,R2		;:    
	MOV	(SP)+,INTUPR	;   
	MOV	(SP)+,INTPRI	; /-    (MDIN.MAC)
;;;	JMP	OTKVU
	RETURN
3$:	MOV	INT100,R1
	CLR	R2
4$:	CALL	SBROS
	INC	R0		;  
	CMP	@SP,INTUPR	;   ?
	BEQ	1$		;
	CMP	2(SP),INTPRI	;    ?
	BEQ	1$		;

	CMP	BF.HZ,NEWFRQ
	BNE	7$		;    
	CMP	BF.HZ+2,NEWFRQ+2
	BNE	7$		;  
	CMP	KONKUR,NEWKUR
	BNE	7$		;    
	CMP	KONKUR+2,NEWKUR+2
	BNE	7$		;  
	CLR	R2
5$:	;;;CALL	LIN.AB
	MOV	(SP)+,INTUPR	;   
	MOV	(SP)+,INTPRI	; /-    (MDIN.MAC)
	RETURN
6$:
	MOV	#-777,R2	;   
	BR	5$			; 
7$:	MOV	#777,R2		; .   
	BR	5$



;   /  300- 
Z300MS:
	MOV R4,-(SP)
	MOV #30.,R4             ;  10- 
Z.R4:	JSR PC,Z10MS            ;  10 
	SOB R4,Z.R4
	MOV (SP)+,R4
	RETURN
;
;   /  10- 
;
Z10MS:
	MOV R3,-(SP)
	MOV #22.,R3
	MOV	#1000.,R3
Z.R3:	;;;WAIT
	SOB R3,Z.R3             ;     10 
	MOV (SP)+,R3
	RETURN

;   *******************************************************************
;   *    /              *
;   *******************************************************************
SBROS:	BIS #B$SBRS,SRK0
	MOV SRK0,RK0
	BIC #B$SBRS,SRK0
	MOV SRK0,RK0
	RETURN

; *************** /     *******************
;
; IN	-	INTPRI, INTUPR, R$PRMM, R$PRMS, RST2
;
; LOCAL	-	RABPPO, IMPORT(2)
;
; OUT	-	BF.HZ(2), KONKUR(2), INTPRI, INTUPR
;
; COMMAND:	MAX=21 ( ""    )
;		MIN=6 (    "0")
; *************************************************************************
;
;INTPRI:	.WORD	0	;   
;RABPPO:	.WORD	0	;  /
;IMPORT:	.BLKW	2	;    
;BF.HZ:		.BLKW	2	; 
;KONKUR:	.BLKW	2	;    ""

VPPO:
	MOV	R0,-(SP)

	MOV	R$PRMM,R0	;     
	MOV	R$PRMS,IMPORT+2	;  

	MOV	R0,IMPORT

	CMPB	R0,#130		; - ""?
	BNE	4$		;
	SWAB	R0
	BIT	#B$NALL,R0	;  - " "?
	BEQ	1$		;
	MOV	RST2,RABPPO	;    
	COM	R0
	XOR	R0,RABPPO	
	BIT	#3,RABPPO	; 0  1 
	BNE	2$		;? 
1$:
	MOV	IMPORT,BF.HZ	;    
	MOV	IMPORT+2,BF.HZ+2;    
	INC	INTUPR		;   
2$:
	INC	INTPRI		;    ;
	MOV	(SP)+,R0
	RTI
4$:
	CMPB	R0,#116		; - ""?
	BNE	5$		;

	MOV	IMPORT,KONKUR	;    
	MOV IMPORT+2,KONKUR+2	;    - 
5$:
	INC	INTPRI		;    
	MOV	(SP)+,R0
	RTI

; ************* /     100 *****************
;
; IN	-	INT100(2), R$ACP, EXPORT(2), BF.KUR(2)
;
; LOCAL	-	RABACP
;
; OUT	-	INT100(2), BFR(512), R$PRDM, R$PRDS
;
; COMMAND:	MAX= ( )
;		   = ( ,    128 )
;		MIN= (  )
;***********************************************************************
;
;INT100:	.WORD	;    100
;RABACP:	.WORD	;  /
;EXPORT:	.BLKW2	;   . 
;BF.KUR:	.BLKW2	; 

VOUT:
	MOV	R0,-(SP)
	MOV	R$ACP,R0	;   - 
	MTPS	#0
	INC	INT100		;  
	BEQ	1$
4$:	MOV	R0,RABACP
	BIC	#177600,RABACP	;   16   7
	ASL	R0
	BCS	10$
	CLRB	R0
	SWAB	R0
	BPL	11$
	ASL	R0
	;;;MOV	RABACP,BFR(R0)	;    
	BIT	#377,R0		;   128?
	BEQ	2$		;
	CMP	#414,R0		; ?
	BEQ	3$		;
	MOV	(SP)+,R0
	RTI
1$:
	INC	INT100+2	;   (1 = 450 ) 
	BR	4$		;
11$:
	ASL	R0
	;;;MOV	RABACP,BFR(R0)	;    
	BIT	#377,R0		;   128?
	BEQ	2$		;
	MOV	(SP)+,R0
	RTI
10$:
	CLRB	R0
	SWAB	R0
	BPL	12$
	ASL	R0
	;;;MOV	RABACP,BFR+512.(R0);    
	BIT	#377,R0		;   128?
	BEQ	2$		;
	CMP	#414,R0		; ?
	BEQ	3$		;
	MOV	(SP)+,R0
	RTI
12$:
	ASL	R0
	;;;MOV	RABACP,BFR+512.(R0);    
	BIT	#377,R0		;   128?
	BEQ	2$		;
	MOV	(SP)+,R0
	RTI
2$:
	ASL	REFKUR		; ?
	BCS	22$		;
	MOV	BF.KUR,R$PRDM
	MOV	BF.KUR+2,R$PRDS
	MOV	(SP)+,R0
	RTI
22$:
	MOV	NEWKUR,BF.KUR
	MOV	NEWKUR+2,BF.KUR+2
	MOV	BF.KUR,R$PRDM
	MOV	BF.KUR+2,R$PRDS
	MOV	(SP)+,R0
	RTI
3$:
	ASL	REFFRQ		; ?
	BCS	33$		;
	MOV	EXPORT,R$PRDM	;   
	MOV	EXPORT+2,R$PRDS	; / OUT130	
	MOV	(SP)+,R0
	RTI
33$:
	MOV	NEWFRQ,EXPORT
	MOV	NEWFRQ+2,EXPORT+2
	MOV	EXPORT,R$PRDM	;   
	MOV	EXPORT+2,R$PRDS	; / OUT130	
	MOV	(SP)+,R0
	RTI

;*************************************************************
B$REFR	= 100000
OUT130:
	MOV	#130,R2		; 
	CLR	R1
	ASHC	#-3,R0		;  32   R0  R1

	MOV	RST2,R3		;  
	COM	R3
	SWAB	R3
	BIC	#176377,R3
	BIS	R3,R1		;   R1
	BISB	R2,R1		;  R1
	BIC	#160000,R0	; ,  ""

	BIS	#20000,R0	; " "
	CALL	PARTET		; 
	ASR	R2		; 1? , !
	BCS	1$
	BIS	#100000,R0	; 
1$:
	CLR	REFFRQ		;  
	MOV	R1,NEWFRQ	;    
	MOV	R0,NEWFRQ+2
	MOV	#B$REFR,REFFRQ	;   
	RETURN

; ***************** /   ()*******************
; 
; IN	-	R0  R1 (   32 . )
;
; LOCAL	-	R3
;
; OUT	-	R2 (    )
;
; ************************************************************************

PARTET:
	MOV	R0,R2		;    
	XOR	R1,R2		; 32    16 
	MOV	R2,R3
	SWAB	R3
	XOR	R3,R2		;   
	MOV	R2,R3
	ASH	#-4,R3
	XOR	R3,R2		;    
	MOV	R2,R3
	ASH	#-2,R3
	XOR	R3,R2		;     
	MOV	R2,R3
	ASR	R3
	XOR	R3,R2		;    
	RETURN
;**************************************************************************

;----------------------
;  /- 
;----------------------
SUCPP:	.WORD

FRQNCY: .WORD 0
KUR:	.WORD 0
STATUS: .WORD 0
SRK0:	.WORD 0
SRK2:	.WORD 0

;-------------------------------
;	 / 
;-------------------------------
RABACP: .WORD		;  / INT100 (MDINT.MAC)
INT100: .BLKW	2	;   
INTPRI: .WORD		;   
INTUPR: .WORD		;   
RABPPO: .WORD		;  / INTPRI (MDINT.MAC)
IMPORT: .BLKW	2	;   
BF.HZ:	.BLKW	2
KONKUR: .BLKW	2
REFFRQ: .WORD
NEWFRQ: .BLKW	2
IFRQ:	.BLKW	2
EXPORT: .BLKW	2
REFKUR: .WORD
NEWKUR: .BLKW	2
BF.KUR: .BLKW	2


;********************************
$ENDAD:	NOP	;JSR	PC,@R0
	NOP
	NOP
	NOP
DOAGN:	CLR	$TESTN
RETURN:	JMP	RESTRT

	.=17400
VEK0:	INC	@#V0
	BR	.+6
VEK4:	INC	@#V4
	BR	.+6
VEK10:	INC	@#V10
	BR	.+6
VEK14:	INC	@#V14
	BR	.+6
VEK20:	INC	@#V20
	BR	.+6
VEK24:	INC	@#V24
	BR	.+6
VEK30:	INC	@#V30
	BR	.+6
VEK34:	INC	@#V34
	BR	.+6
VEK100:INC	@#V100
	BR	.+6
VEK170:INC	@#V170
	BR	SAVRON

	.=17500
SAVRON:	MOV	2(SP),@#MRS
	MOV	@SP,@#MPC
	MOV	SP,@#MSP
	MOV	R5,@#MR5
	MOV	R4,@#MR4
	MOV	R3,@#MR3
	MOV	R2,@#MR2
	MOV	R1,@#MR1
	MOV	R0,@#MR0 
1$:	WAIT	
	BR	1$
VEK174:INC	@#V174
	BR	SAVRON
VEK250:INC	@#V250
	BR	SAVRON
VEK274:INC	@#V274
	BR	SAVRON
VEKXX:	INC	@#VXXX
	BR	SAVRON
	.=17722
V0:	.WORD	0
V4:	.WORD	0
V10:	.WORD	0
V14:	.WORD	0
V20:	.WORD	0
V24:	.WORD	0
V30:	.WORD	0
V34:	.WORD	0
V100:	.WORD	0
V170:	.WORD	0
V174:	.WORD	0
V250:	.WORD	0
V274:	.WORD	0
VXXX:	.WORD	0
	.=17756
MR0:	.WORD	0
MR1:	.WORD	0
MR2:	.WORD	0
MR3:	.WORD	0
MR4:	.WORD	0
MR5:	.WORD	0
MSP:	.WORD	0
MPC:	.WORD	0
MRS:	.WORD	0
	.END	

